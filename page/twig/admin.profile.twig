{% extends "base.twig" %}

{% set navbar_dark = true %}
{% block navbar_menu %}
    {% include 'template/navbar_item.twig' with {'href': baseurl ~ '/', 'html': 'Home'} %}
    {% include 'template/navbar_item.twig' with {'href': baseurl ~ '/logout', 'html': 'Logout'} %}
{% endblock navbar_menu %}

{% block body %}
    <div class="container pt-5 d-flex flex-wrap-reverse">
        <div class="col-lg-8 pt-5">
            <div id="store">
                <div class="px-2 mb-4">
                    <h2 class="section-heading m-0">Store Days</h2>
                </div>
                <div class="card mb-3">
                    <div class="form-group d-flex flex-wrap py-3 px-2 m-0">
                        <div class="col-md-2 py-1 px-1">
                            <select id="store-day" class="custom-select">
                                <option selected disabled>Day of the Week</option>
                                <option value="mon">Mon</option>
                                <option value="tue">Tue</option>
                                <option value="wed">Wed</option>
                                <option value="thu">Thu</option>
                                <option value="fri">Fri</option>
                                <option value="sat">Sat</option>
                                <option value="sun">Sun</option>
                            </select>
                        </div>
                        <div class="col-md-4 py-1 px-1">
                            <input id="store-open" class="form-control" type="text" placeholder="Opens">    
                        </div>
                        <div class="col-md-4 py-1 px-1">
                            <input id="store-close" class="form-control" type="text" placeholder="Closes">
                        </div>
                        <div class="col-md-2 py-1 px-1">
                            <input id="store-tables" class="form-control" type="text" placeholder="Tables">
                        </div>
                        <div class="w-100 pt-2 px-2 text-right">
                            <div id="store-save" class="btn btn-primary btn-sm">Create</div>
                        </div>
                    </div>
                </div>
                <table id="store-table" class="table table-bordered">
                    <thead>
                        <th>ID</th>
                        <th>Day</th>
                        <th>Opens</th>
                        <th>Closes</th>
                        <th>Tables</th>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div id="users">
                <div class="px-2 mb-4">
                    <h2 class="section-heading m-0">Users</h2>
                </div>
                <table id="user-table" class="table table-bordered">
                    <thead>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Firstname</th>
                        <th>Lastname</th>
                        <th>Admin</th>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div id="reservations">
                <div class="px-2 mb-4">
                    <h2 class="section-heading m-0">Reservations</h2>
                </div>
                <table id="reservation-table" class="table table-bordered">
                    <thead>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>People</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-lg-4 pt-5">
            <div class="card w-100 mt-3">
                <div class="card-body d-flex flex-wrap">
                    <h5 class="card-title text-center w-100">{{ session.user.email }}</h5>
                    {% if session.user.firstname or session.user.lastname %}
                    <h6 class="card-subtitle text-muted w-50 m-0 text-center">
                        {% if session.user.firstname %}
                            {{ session.user.firstname }} 
                        {% endif %}
                        {{session.user.lastname}}
                    </h6>
                    {% else %}
                    <p class="card-text w-100">To make a reservation you have to fill out your details</p>
                    {% endif %}
                    <a href="#details" class="card-link w-50 text-center">My details</a>
                    <a href="#reservations" class="card-link text-center">Reservations</a>
                    <a href="#users" class="card-link text-center">Users</a>
                    <a href="#store" class="card-link text-center">Store</a>
                </div>
                <!-- <div class="card-footer">
                    <div class="form-group m-0">
                        <div class="form-control mb-1 p-0 d-flex">
                            <span class="py-2 px-3 bg-light rounded-left"><i class="fa fa-users"></i></span>
                            <div style="flex-grow: 1">
                                <input
                                    id="reservation-people"
                                    placeholder="User"
                                    style="border: none;"
                                    class="w-100 py-2 px-2 rounded-right"
                                    type="text"
                                />
                            </div>
                        </div>
                        <div class="form-control mb-1 p-0 d-flex">
                            <span class="py-2 px-3 bg-light rounded-left"><i class="fa fa-users"></i></span>
                            <div style="flex-grow: 1">
                                <input
                                    id="reservation-people"
                                    placeholder="Number of customers"
                                    style="border: none;"
                                    class="w-100 py-2 px-2 rounded-right"
                                    type="text"
                                />
                            </div>
                        </div>
                        <div class="form-control mb-1 p-0 d-flex">
                            <span class="py-2 px-3 bg-light rounded-left"><i class="fa fa-calendar"></i></span>
                            <div style="flex-grow: 1;">
                                <input
                                    id="reservation-date"
                                    placeholder="Reservation date"
                                    style="border: none;"
                                    class="w-100 py-2 px-2 rounded-right"
                                    type="text"
                                />
                            </div>
                        </div>
                        <div class="form-control mb-1 p-0 d-flex">
                            <span class="py-2 px-3 bg-light rounded-left"><i class="fa fa-clock-o"></i></span>
                            <div style="flex-grow: 1;">
                                <input
                                    id="reservation-time"
                                    placeholder="Reservation time"
                                    style="border: none;"
                                    class="w-100 py-2 px-2 rounded-right"
                                    type="text"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="d-flex pt-2">
                        <button id="reservation-save" type="button" class="btn btn-primary w-50">Save</button>
                        <button id="reservation-cancel" type="button" class="btn btn-warning w-50">Clear</button>
                    </div>
                </div> -->
            </div>
        </div>
    </div>
    
    {% include 'template/modal_details.twig' %}
{% endblock body %}

{% block custom_js %}
<script>
    const app = {};
    
    function getReservations () {
        api.ajax({
            url: '/reservation',
            method: 'GET'
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                return toastr.error(data.description);
            }
            if (app.reservation_table) {
                app.reservation_table.destroy();
            }
            let count = 1;
            let cancel_btn = '<div class="btn btn-danger btn-sm"><i class="fa fa-trash"></i> Cancel</div>';
            data.results.forEach(res => {
                let d = new Date(res.res_date + " " + res.res_time + "Z");
                d = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}, ${d.toLocaleTimeString()}`;
                $("#reservation-table tbody").append(
                    `<tr>
                    <td>${res.id}</td>
                    <td>${res.user_id}</td>
                    <td>${res.people}</td>
                    <td>${d}</td>
                    <td>${res.status || cancel_btn }</td>
                    </tr>`
                );
                count++;
            });
            app.reservation_table = $('#reservation-table').DataTable();
        })
        .catch(res => toastr.error(res));
    }
    
    function getUsers () {
        api.ajax({
            url: '/user',
            method: 'GET'
        })
        .then(res => res.json())
        .then(data => {
            if (app.user_table) {
                app.user_table.destroy();
            }
            let str = "";
            data.results.forEach(user => {
                str += `
                    <tr><td>${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.firstname}</td>
                    <td>${user.lastname }</td>
                    <td>${user.is_admin }</td></tr>`;
            });
            $("#user-table tbody").append(str);
            app.user_table = $('#user-table').DataTable();
        })
        .catch(res => toastr.error(res));
    }
    
    function getStore () {
        api.ajax({
            url: '/store',
            method: 'GET'
        })
        .then(res => res.json())
        .then(data => {
            if (app.store_table) {
                app.store_table.destroy();
            }
            let str = "";
            data.results.forEach(sd => {
                str += `
                    <tr><td>${sd.id}</td>
                    <td>${sd.day}</td>
                    <td>${sd.open_time}</td>
                    <td>${sd.close_time}</td>
                    <td>${sd.tables}</td></tr>`;
            });
            $("#store-table tbody").append(str);
            app.store_table = $('#store-table').DataTable();
        })
        .catch(res => toastr.error(res));
    }
    
    function saveStore () {
        let day = $("#store-day").val();
        let open = $("#store-open").val();
        let close = $("#store-close").val();
        let tables = $("#store-tables").val();
        
        api.ajax({
            url: '/store',
            method: 'POST',
            body: {
                day: day,
                open: open,
                close: close,
                tables: tables
            }
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                return toastr.error(data.description);
            }
            getStore();
        })
        .catch(res => toastr.error(res));
    }
    
    
    // Shorthand version of $(document).ready();
    $(() => {
        $('a[href="#details"]').click(() => $("#details-modal").modal("show"));
        $('a[href="#reservations"]').click(() => {
            $("#reservations").show();
            $("#users").hide();
            $("#store").hide();
            getReservations();
        });
        $('a[href="#users"]').click(() => {
            $("#reservations").hide();
            $("#users").show();
            $("#store").hide();
            getUsers();
        });
        $('a[href="#store"]').click(() => {
            $("#reservations").hide();
            $("#users").hide();
            $("#store").show();
            getStore();
        });
        
        $("#store-save").click(saveStore);
        
        getReservations();
        
        $("#users").hide();
        $("#store").hide();
        
        $('#reservation-cancel').click(() => $("#reservation-people, #reservation-date, #reservation-time").val(""));
        
        $('#reservation-save').click(() => {
            let people = $('#reservation-people ').val();
            let date = $('#reservation-date ').val();
            let time = $('#reservation-time').val();
            
            if (!people) {
                return toastr.error("Please enter the number of people");
            }
            if (!date) {
                return toastr.error("Please enter the date of the reservation");
            }
            if (!time) {
                return toastr.error("Please enter the time of the reservation");
            }
            
            api.createReservation({
                people: people,
                date: new Date(date + " " + time).toISOString()
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    toastr.success(data.description + ". Reloading!");
                    setTimeout(function(){ window.location.reload() }, 1000);
                } else {
                    toastr.error(data.description);
                }
            })
            .catch(err => {
                toastr.error(err);
            });
        });
        
        $('#modal-details-button').click(() => {
            let firstname = $("#details-firstname").val();
            let lastname = $("#details-lastname").val();
            
            if (!firstname) {
                return toastr.error("Please enter your firstname");
            }
            
            if (!lastname) {
                return toastr.error("Please enter your lastname");
            }
            
            api.updateProfile({
                firstname: firstname,
                lastname: lastname
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    toastr.success(data.description + ". Reloading!");
                    $("#details-modal").modal("hide");
                    setTimeout(function(){
                        window.location.reload();
                    }, 1000);
                } else {
                    toastr.error(data.description);
                }
            })
            .catch(err => {
                toastr.error(err);
            });
        });
        
        flatpickr("#reservation-date", {
            minDate: new Date()
        });
        
        flatpickr("#reservation-time", {
            enableTime: true,
            noCalendar: true,
            minTime: "16:00",
            maxTime: "22:00"
        });
        
        flatpickr("#store-open", {
            enableTime: true,
            noCalendar: true
        });
        flatpickr("#store-close", {
            enableTime: true,
            noCalendar: true
        });
    });
</script>
{% endblock custom_js %}